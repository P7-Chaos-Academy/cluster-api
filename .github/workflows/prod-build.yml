name: Prod Build

on:
  push:
    branches:
      - main

jobs:
  build:
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/build.yml@main
    with:
      language: python
      python_version: '3.11'

  containerize:
    needs: build
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/containerize.yml@main
    with:
      image_name: cluster-api
      platforms: linux/arm64
      tag_latest: true
      registry_username: cgamel
    secrets:
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  update-gitops:
    needs: containerize
    uses: P7-Chaos-Academy/shared-workflows/.github/workflows/manifest-update.yml@main
    with:
      gitops_repo: P7-Chaos-Academy/gitops
      manifest_path: pi/cluster-api/cluster-deployment.yaml
      new_image: ${{ needs.containerize.outputs.full_image }}
      commit_message: 'Update cluster-api image to ${{ needs.containerize.outputs.image_tag }}'
    secrets:
      GITOPS_REPO_TOKEN: ${{ secrets.GITOPS_REPO_TOKEN }}
